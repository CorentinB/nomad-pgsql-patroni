# nomad-pgsql-patroni

A simple container running Postgres and Patroni useful for dropping directly into a Hashicorp environment (Nomad + Consul + Vault)

It also comes pre-baked with some tools and extensions

### Tools

| Name | Version | Link |
|--|--|--|
| awscli | 1.22.37 | https://pypi.org/project/awscli/ |
| WAL-G | 1.1 | https://github.com/wal-g/wal-g |
| Patroni | 2.1.2 | https://github.com/zalando/patroni |
| vaultenv | 0.14.0 | https://github.com/channable/vaultenv |

### Extensions

| Name | Version | Link |
|--|--|--|
| Timescale | 2.5.1 | https://www.timescale.com |
| PostGIS | 3.2.0 | https://postgis.net |
| pgRouting | 3.2.1 | https://pgrouting.org |
| postgres-json-schema | 0.1.1 | https://github.com/gavinwahl/postgres-json-schema |
| vector | 0.2.2 | https://github.com/ankane/pgvector |

### Running another version of Postgres?

See the [`pg-11`](https://github.com/ccakes/nomad-pgsql-patroni/tree/pg-11) or [`pg-13`](https://github.com/ccakes/nomad-pgsql-patroni/tree/pg-12) branch for other Postgres versions. Otherwise, jump to [`master`](https://github.com/ccakes/nomad-pgsql-patroni) for the latest and greatest! :sparkles:

## Usage
```hcl
# main.tf
resource "nomad_job" "postgres" {
  jobspec = "${file("${path.module}/job.hcl")}"
}

# job.hcl
job "your-task" {
  type = "service"
  dataceners = ["default"]

  vault { policies = ["postgres"] }

  group "your-group" {
    count = 3

    task "db" {
      driver = "docker"

      template {
        data <<EOL
scope: postgres
name: pg-{{env "node.unique.name"}}
namespace: /nomad

restapi:
  listen: 0.0.0.0:{{env "NOMAD_PORT_api"}}
  connect_address: {{env "NOMAD_ADDR_api"}}

consul:
host: consul.example.com
token: {{with secret "consul/creds/postgres"}}{{.Data.token}}{{end}}
register_service: true

# bootstrap config
EOL
      }

      config {
        image = "ccakes/nomad-pgsql-patroni:12.9-1.tsdb_gis"

        port_map {
          pg = 5432
          api = 8008
        }
      }

      resources {
        memory = 1024

        network {
          port "api" {}
          port "pg" {}
        }
      }
    }
  }
}
```

## Testing

An example `docker-compose` file and patroni config is included to see this running.
```shell
$ docker-compose -f docker-compose.test.yml up
```

## ISSUES

Postgres runs as the postgres user however that user has been added to the root group. This probably has some security ramifications that I haven't thought of, but it's required for postgres to read TLS keys generated by Vault and written as templates.

[hashicorp/nomad#5020](https://github.com/hashicorp/nomad/issues/5020) is tracking (hopefully) a fix for this.
